	$BEGIN	TRNCLS,<28.1>,<TRUNCATE CLOSE>
; 
; THIS  SOFTWARE  IS FURNISHED UNDER A LICENSE AND MAY
; BE USED OR COPIED ONLY IN ACCORDANCE WITH THE  TERMS
; OF SUCH LICENSE.
;  
; COPYRIGHT (c) 1982 BY DIGITAL EQUIPMENT CORPORATION.
; ALL RIGHTS RESERVED.
; 
; PREVIOUSLY MODIFIED BY
;
;	JOHN ALLEN PAINTER
;	S. RUZICH
;
;
; CLOSE FILE TRUNCATING THE UNUSED BLOCKS
;
; MACRO CALLS
;
; LOCAL SYMBOLS
;
; PURE DATA AREA
;
; IMPURE DATA AREA
;


;+
; CLOSE FILE TRUNCATING UNUSED BLOCKS
; CALLING SEQUENCE:
;	CALL .TRNCL
; INPUTS:
;	R0 = FDB
; OUTPUTS:
;	ALL REGISTERS PRESERVED
;	C = 0 IF SUCCESSFUL, C = 1 IF ERROR
;	ERRORS FROM .CLOSE HAVE PRECEDENCE
; 	OVER ERRORS FROM THE TRUNCATE CALL
;
; NOTES:
;	THE USER MUST HAVE THE FILE WRITE
;	ACCESSED, AND HAVE EXTEND PRIVILEGES
;	OR THE TRUNCATE CALL WILL FAIL
;
; OPERATION:
;	THE FILE IS TRUNCATED BACK TO F.EFBK
; OR F.EFBK-1 IF F.FFBY = 0. THEN F.HIBK IS
; SET TO THE NEW ALLOCATION LENGTH WHICH IS
; THE SPECIFIED VBN FOR THE TRUNCATION ADJUSTED
; BY THE ROUNDUP FACTOR RETURNED BY THE ACP
; (IOSTATUS +2) TO ACCOUNT FOR CLUSTERING.
; THE FILE IS THEN CLOSED VIA .CLOSE
;
;-

.TRNCL::
	TST	F.BDB(R0)		;FILE OPEN?
	BEQ	10$			;NO - ERROR
	BITB	#FD.SQD!FD.REC,F.RCTL(R0) ;RECORD OR TAPE DEVICE?
	BNE	5$			;YES- JUST CLOSE THE FILE
	BISB	#FD.TRN,F.BKP1(R0)	;NO - DISK - SET AUTO-TRUNCATE ON
5$:	CALLR	.CLOSE			;CLOSE AND TRUNCATE FILE
10$:	MOVB  #IE.ILL,F.ERR(R0)	;ILLEGAL OPERATION FILE MUST BE OPEN
	CALLR  ..FCSX		;RETURN
;
;
	$END	TRNCLS
;
;
	.END
