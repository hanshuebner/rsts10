TITLE	CVT$$,<TRIM A STRING>,0A,10-MAY-91,ABC

;
;		COPYRIGHT (c) 1974, 1991 BY
;	DIGITAL EQUIPMENT CORPORATION, MAYNARD, MASS.
;
; THIS SOFTWARE IS FURNISHED UNDER A LICENSE AND MAY BE USED AND  COPIED
; ONLY  IN  ACCORDANCE  WITH  THE  TERMS  OF  SUCH  LICENSE AND WITH THE
; INCLUSION OF THE ABOVE COPYRIGHT NOTICE.  THIS SOFTWARE OR  ANY  OTHER
; COPIES  THEREOF MAY NOT BE PROVIDED OR OTHERWISE MADE AVAILABLE TO ANY
; OTHER PERSON.  NO TITLE TO AND OWNERSHIP OF  THE  SOFTWARE  IS  HEREBY
; TRANSFERRED.
;
; THE INFORMATION IN THIS SOFTWARE IS SUBJECT TO CHANGE  WITHOUT  NOTICE
; AND  SHOULD  NOT  BE  CONSTRUED  AS  A COMMITMENT BY DIGITAL EQUIPMENT
; CORPORATION.
;
; DIGITAL ASSUMES NO RESPONSIBILITY FOR THE USE  OR  RELIABILITY  OF ITS
; SOFTWARE ON EQUIPMENT WHICH IS NOT SUPPLIED BY DIGITAL.
;

;+
; CVT$$  - TRIM A STRING
; CVT$$A - TRIM EVERYTHING OFF A STRING
;
; CALL:	R0 = TRIM MASK (IF CVT$$)
;	R5 -> ASCIZ STRING
;	CALL	CVT$$?
;
; BACK:	R5 -> ASCIZ STRING (MAY BE SHORTER) AT SAME PLACE
;	MASK	TRIMS
;	   1	DISCARD ALL PARITY BITS
;	   2	DISCARD ALL SPACES & TABS
;	   4	DISCARD CR LF FF ESC RO
;	  10	DISCARD LEADING SPACES & TABS
;	  20	REDUCE SPACES & TABS TO A SINGLE SPACE
;	  40	CONVERT LC TO UC
;	 100	CONVERT [ TO ( AND ] TO )
;	 200	DISCARD TRAILING SPACES & TABS
;	 400	PRESERVE QUOTED SUBSTRINGS
;	1000	MODIFY 4 (IF ON) TO DISCARD ALL CHARACTERS < 40 OR =177
;-
.CSECT

.ENABL	LSB

CVT$$A::CALLX	SAVREG,R5	;THIS ENTRY TRIMS THE WORLD
	MOV	#-1,R0		;SET FLAG WORD TO TRIM ALL
	BR	5$

CVT$$::	CALLX	SAVREG,R5	;SAVE REGISTERS
5$:	MOV	R5,R4		;R4 -> OUTPUT STRING
	CLR	-(SP)		;NOT IN QUOTES YET
	MOV	#160$,R1	;TABLE OF THINGS TO CLEAR
	ASH	#7,R0		;SHIFT THE MASK
	BCC	10$		;DUMP ONLY JUNK BYTES
	CLR	R1		;DUMP ALL BYTES < 40 OR =177
10$:	MOVB	(R5)+,R2	;GET A BYTE
	BEQ	120$		;DONE, SO EXIT
	BICB	R0,R2		;TURN OFF PARITY IF DESIRED
	TST	R0		;KEEP QUOTED BYTES?
	BPL	40$		;NO, QUOTES ARE NORMAL
	TSTB	(SP)		;YES, ARE WE WITHIN QUOTES?
	BEQ	20$		;NO
	CMPB	R2,(SP)		;YES, IS THIS THE ENDING QUOTE?
	BNE	110$		;NO
	CLRB	(SP)		;YES, CLEAR THE INSIDE FLAG
	BR	110$		;AND KEEP THE CLOSING QUOTE

20$:	CMPB	R2,#''		;START OF QUOTED STRING?
	BEQ	30$		;YES
	CMPB	R2,#'"		;MAYBE THIS KIND?
	BNE	40$		;NO
30$:	MOVB	R2,(SP)		;YES, START THE QUOTATION
	BR	110$		;AND KEEP THE OPENING QUOTE

40$:	BIT	R0,#4*200	;DISCARD TERMINATORS AND JUNK?
	BEQ	60$		;NO
	MOV	R1,R3		;YES, GET THE LIST POINTER
	BNE	50$		;DISCARD ONLY JUNK
	CMPB	R2,#40		;DISCARD ALL CONTROL CHARACTERS
	BLO	10$		;IT IS CONTROL
	CMPB	R2,#177		;ALSO DUMP RUBOUTS
	BEQ	10$
	BR	60$		;KEEP IT FOR NOW

50$:	CMPB	R2,(R3)+	;DOES THE BYTE MATCH THE LIST?
	BLO	50$		;NO, KEEP CHECKING
	BEQ	10$		;YES, DISCARD IT
	;BHI	60$		;NO, DON'T CHECK FURTHER
60$:	CMPB	R2,#40		;IS THIS A SPACE?
	BEQ	70$		;YES
	CMPB	R2,#11		;NO, MAYBE A TAB
	BNE	80$		;NOPE
70$:	BIT	R0,#2+10*200	;DISCARD ALL AND/OR LEADING ONES?
	BNE	10$		;YES, DISCARD THIS BYTE
	BIT	R0,#20*200	;REDUCE SPACES/TABS?
	BEQ	110$		;NO, JUST OUTPUT IT
	MOVB	#40,R2		;YES, THIS WILL BE A SPACE
	CMP	R4,5*2+2+2(SP)	;HAVE WE OUTPUT ANYTHING YET?
	BEQ	110$		;NO, CONVERT TO A SPACE AND OUTPUT IT
	CMPB	R2,-1(R4)	;YES, IS THE PRECEDING A SPACE?
	BEQ	10$		;IF SO, DISCARD THIS ONE
	BR	110$		;OUTPUT IT

80$:	BIT	R0,#40*200	;CONVERT LC TO UC?
	BEQ	90$		;NO
	CMPB	R2,#'A+40	;IS IT LC ALPHA?
	BLO	90$		;NO
	CMPB	R2,#'Z+40	;MAYBE?
	BHI	90$		;NO
	BICB	#40,R2		;YES, DOWNCASE IT
	BR	110$		;AND OUTPUT UC

90$:	BIT	#100*200,R0	;CONVERT [] TO ()?
	BEQ	110$		;NO
	CMPB	R2,#'[		;YES, IS IT [?
	BEQ	100$		;YES
	CMPB	R2,#']		;IS IT ]?
	BNE	110$		;NO
	DECB	R2		;IT IS ], SO ] = 135-64 = ) = 51
100$:	SUB	#'[-'(,R2	;AND         [ = 133-63 = ) = 50
110$:	MOVB	R2,(R4)+	;OUTPUT ONE BYTE TO NEW STRING
	BIC	#10*200,R0	;TURN OFF LEADING SPACE/TAB
	BR	10$		;LOOP FOR ANOTHER BYTE

120$:	TSTB	(SP)+		;WERE WE INSIDE QUOTES AT THE END?
	BNE	150$		;YES, DON'T TRIM TRAILING STUFF
	ASL	R0		;NO, DO WE DISCARD TRAILING SPACES/TABS?
	BPL	150$		;NO
130$:	MOVB	-(R4),R2	;GET LAST BYTE STORED
	CMP	R4,5*2+2(SP)	;BACK TOO FAR?
	BLO	140$		;YES, RETURN NULL STRING
	CMPB	R2,#40		;NO, IS IT SPACE?
	BEQ	130$		;YES, DISCARD IT
	CMPB	R2,#11		;MAYBE TAB?
	BEQ	130$		;DISCARD TAB
140$:	INC	R4		;KEEP LAST BYTE REMOVED
150$:	CLRB	(R4)+		;SET NULL STOPPER
	RTS	PC

160$:	.BYTE	177,33,15,14,12,0

.DSABL	LSB

.END

