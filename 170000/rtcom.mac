.IIF	NDF	L$$IST,	.NLIST
.IIF	NDF	L$$IST,	.DSABL	CRF
TITLE	RTCOM,<RT11 EMULATOR DEFINITIONS>,0A,10-MAY-91,SJK/GMB

;
;		COPYRIGHT (c) 1974, 1991 BY
;	DIGITAL EQUIPMENT CORPORATION, MAYNARD, MASS.
;
; THIS SOFTWARE IS FURNISHED UNDER A LICENSE AND MAY BE USED AND  COPIED
; ONLY  IN  ACCORDANCE  WITH  THE  TERMS  OF  SUCH  LICENSE AND WITH THE
; INCLUSION OF THE ABOVE COPYRIGHT NOTICE.  THIS SOFTWARE OR  ANY  OTHER
; COPIES  THEREOF MAY NOT BE PROVIDED OR OTHERWISE MADE AVAILABLE TO ANY
; OTHER PERSON.  NO TITLE TO AND OWNERSHIP OF  THE  SOFTWARE  IS  HEREBY
; TRANSFERRED.
;
; THE INFORMATION IN THIS SOFTWARE IS SUBJECT TO CHANGE  WITHOUT  NOTICE
; AND  SHOULD  NOT  BE  CONSTRUED  AS  A COMMITMENT BY DIGITAL EQUIPMENT
; CORPORATION.
;
; DIGITAL ASSUMES NO RESPONSIBILITY FOR THE USE  OR  RELIABILITY  OF ITS
; SOFTWARE ON EQUIPMENT WHICH IS NOT SUPPLIED BY DIGITAL.
;

.SBTTL	EDIT HISTORY FOR RTCOM
;+
;
;  000  RRF  06-MAR-81	CREATION - COPIED FROM V7.0-07
;  001  GMB  16-Oct-84	Added CSISIZ for longer CSI command lines.
;  002  GMB  16-Oct-84	Added CSIFLG to handle non-sticky devices in CSI.
;
;-

;				"Who in the world am I?
;				 Ah, that's the great puzzle!"
;				- Lewis Carroll,
;					Alice's Adventures in Wonderland

RT1VEL	= "03
SY.VER	= 3	;EMULATE V3 OF RT11
SY.UPD	= 3	;UPDATE LEVEL 3

.DSECT	30
R.PARM:	.BLKW		;FQNENT VALUE ON .RUN
	.BLKW		;XRB+0 FLAGS ON .RUN
	.BLKW
	.BLKW
USERPC:	.BLKW		;START ADDRESS OF USER PROGRAM
USERSP:	.BLKW		;USER'S INITIAL STACK
JSW:	.BLKW		;JOB STATUS WORD
	.BLKW		;
USERTOP:.BLKW		;TOP ADDRESS OF USER PROGRAM
ERRBYT:	.BLKW		;RETURNED ERROR CODE
SYSPTR:	.BLKW		;POINTER TO R/W AREA

; BIT DEFINITIONS IN THE JSW

.BSECT
	.BLKB	.	;UNUSED
	.BLKB	.
	.BLKB	.
	.BLKB	.
	.BLKB	.
	.BLKB	.
TCBIT$:	.BLKB	.	;REALLY RETURN C-BIT IF NO TTY INPUT
	.BLKB	.
CHAIN$:	.BLKB	.	;PROGRAM ENTERED VIA CHAIN
OVLY$:	.BLKB	.	;PROGRAM IS OVERLAID
	.BLKB	.
	.BLKB	.
TTSPC$:	.BLKB	.	;TELETYPE SPECIAL MODE
RSTRT$:	.BLKB	.	;PROGRAM IS RESTARTABLE
TTLC$:	.BLKB	.	;DO NOT TRANSLATE LC TO UC
USWAP$:	.BLKB	.	;USR SWAPS (?)

; RT-11 DEVICE STATUS BITS

.DSECT	10000
SPECL$:	.BLKB	.	;DEVICE IS SPECIAL
WONLY$:	.BLKB	.	;DEVICE IS WRITE-ONLY
RONLY$:	.BLKB	.	;DEVICE IS READ-ONLY
FILST$:	.BLKB	.	;DEVICE IS FILE STRUCTURED

; MAGTAPE SPECIAL FUNCTIONS

.DSECT
MT.RUN:	.BLKB		;REWIND AND OFF-LINE
MT.WEF:	.BLKB		;WRITE EOF
MT.REW:	.BLKB		;REWIND
MT.FSR:	.BLKB		;FORWARD SPACE RECORDS
MT.BSR:	.BLKB		;BACKSPACE RECORDS
MT.DEN:	.BLKB		;SET DENSITY/PARITY
MT.STS:	.BLKB		;GET STATUS
MT.CHN:	.BLKB		;GET CHANNEL STATISTICS
MT.RWC:	.BLKB		;SET TO REWIND ON CLOSE

; ASCII DEFINITIONS

.EQUATE	BELL,	 7
.EQUATE	TAB,	11
.EQUATE	LF,	12
.EQUATE	FF,	14
.EQUATE	CR,	15
.EQUATE	ESCAPE,	33
.EQUATE	SPACE,	40

; DEFINE NON-RT11 EMTS TO EMULATOR

.DSECT	EMT!360		; DEFINE EMTS TO RT11

.SETFQB:.BLKB		; SET UP FIRQB FROM RT11 PARAMETER BLOCK
.DATTIM:.BLKB		; CONVERT DATE/TIME TO STRING
.SETCC:	.BLKB		; SET CONTROL-C TRAP VECTOR
.DORUN:	.BLKB		; DO A RSTS .RUN WITH LOGICAL TABLE RESTORED
.ERRPRT:.BLKB		; PRINT RSTS ERROR TEXT ON USER'S CONSOLE
.DOFSS:	.BLKB		; DO A RSTS .FSS ON .ASCIZ STRING
.GETCOR:.BLKB		; EXPAND USER'S CORE ALLOCATION
.DOCCL:	.BLKB		; EXECUTE A .CCL WITH LOGICAL TABLE RESTORED
.CLRFQB:.BLKB		; CLEAR USER FIRQB
.CLRXRB:.BLKB		; CLEAR USER FIRQB

; DEFINE PREFIX EMT TO RSTS

.EQUATE	.PRIV,	EMT!377	; MUST PREFIX ALL RSTS BOUND EMTS

; COMMON MACRO FOR PROGRAM NAMES

.MACRO	.PRGID	NAME
	 .ASCII	"NAME"<11>
	 .BYTE	'V,<SYSVEL&377>,<SYSVEL/400&377>
	 .BYTE	   <SYSVEE&377>,<SYSVEE/400&377>
	 .BYTE	'-,<$$$VER&377>,<$$$VER/400&377>
.ENDM	.PRGID

; CHANNEL DEFINITIONS

; EACH RT-11 CHANNEL IS MAPPED ONTO A RSTS CHANNEL.
; THERE IS A CHANNEL BLOCK ASSOCIATED WITH EACH RSTS CHANNEL,
; INDICATING WHETHER IT IS IN USE, THE OPEN FILE NAME, ETC.

.DSECT	
CH$FLG:	.BLKW		;CHANNEL FLAG
CH$DEV:	.BLKW		;DEVICE NAME (RAD50)
CH$FN1:	.BLKW	2	;FILE NAME
CH$EXT:	.BLKW		;EXTENSION
CH$DTB:			;PPN WORD SERVES AS DT BUFFER PTR ON DECTAPE
CH$PPN:	.BLKW		;PPN
CH$CHN:	.BLKW		;RSTS CHANNEL NUMBER * 2 (BYTE)
CH$STS:	.BLKW		;FLAG WORD FROM OPEN

CHANSZ:			;SIZE OF A CHANNEL BLOCK

; DEFINITION OF CHANNEL FLAG WORD BITS

.EQUATE	RTCHAN,	36	;BITS 4-1 HAVE RT-11 CHANNEL #

.DSECT	200
CS$ENT:	.BLKB	.	;CHANNEL OPENED FOR OUTPUT (NO SAVESTATUS)
CS$IOD:	.BLKB	.	;I/O HAS BEEN DONE (TAPE NOT AT BLOCK 1)
.DSECT	20000		;BITS 12-9 (17000) HAVE INTERNAL DEVICE INDEX
CS$EOF:	.BLKB	.	;EOF PENDING ON CHANNEL
	.BLKB	.	;RESERVED
CS$OPN:	.BLKB	.	;CHANNEL IS CURRENTLY OPEN

; SYMBOLS FOR THINGS USED OR RETURNED BY RSTS, WHICH ARE NOT IN COMMON
.EQUATE	NLOGS,	   4	;NUMBER OF LOGICAL ASSIGNMENTS
.EQUATE	LOGSIZ,	  44	;SIZE OF LOGICAL ASSIGNMENT TABLE
.EQUATE	TTIBFL,	128.	;LENGTH OF TELETYPE INTERNAL BUFFER
.EQUATE	CSIPBS,	10.*2	;LENGTH OF CSISPC INTERNAL PARAMETER BLOCK
			;(PTR, PPN, PROTECTION, MODE, CLUSTERSIZE)

; THE TOP OF THE LOW SEGMENT OF THE USER'S IMAGE HOLDS PARAMETERS
;	UNIQUE TO EACH USER.
; THIS AREA IS POINTED TO BY LOCATION 54 (SYSPTR)
; CERTAIN OFFSETS CONTAIN INFORMATION EXPECTED BY RT-11

.DSECT	
SPCBLK:			;USER PUTS IN SPECIAL BLOCK # FOR R/W
PPN:	.BLKW		;ONE-SHOT PPN TO USE THIS TIME
RWMSBS:			;ONE-SHOT MSB OF FILE LBN FOR R/W
PROTEC:	.BLKW		;ONE-SHOT PROTECTION CODE
MODE:	.BLKW		;ONE-SHOT MODE
CLUSTR:	.BLKW		;ONE-SHOT CLUSTERSIZE
POSITN:	.BLKW		;ONE-SHOT POSITION
CRMSBS:	.BLKB		;ONE-SHOT MSB OF FILE SIZE FOR CREATES
NOTRNS:	.BLKB		;ONE-SHOT DON'T TRANSLATE LOGICALS ON OPENS

; KEEP THE FOLLOWING IN ORDER ...
LOGTBL:			;COPY OF BASIC+ LOGICAL ASSIGNMENT TABLE
LOGPPN:	.BLKW		;DEFAULT PPN
DEFPRO:	.BLKW		;DEFAULT PROTECTION CODE
LOGNAM:	.BLKW	4*NLOGS	;LOGICAL ASSIGNMENT TABLE
LIBPPN:	.BLKW		;LIBRARY PPN FOR SEARCH LIST
DEFPPN:	.BLKW		;DEFAULT PPN (IN SEARCH LIST)
PRVSIZ:	.BLKW		;PREVIOUS RTS SIZE
; ... TO HERE

; KEEP THE FOLLOWING IN ORDER ...
NOCTLC:	.BLKW		;DISABLE CONTROL-C FLAG
USERCC:	.BLKW		;USER'S ^C ROUTINE
FPADDR:	.BLKW		;ADDRESS OF USER FPP TRAP ROUTINE
TRAPAD:	.BLKW		;ADDRESS OF USER TRAP TO 4/10 ROUTINE
CCADDR:	.BLKW		;USER'S RT-11 ^C ROUTINE
CTLCSP:	.BLKW	<FQBSIZ+XRBSIZ>/2+1 ;USER SP WHEN INTERRUPTED BY CTRL/C
; ... TO HERE

LASTER:	.BLKB		;CODE OF LAST UNEXPECTED RSTS ERROR
GETCNT:	.BLKB		;COUNT OF NUMBER OF GET'S DONE
STKLVL:	.BLKW		;RESET SP FOR FAILING CSI CALLS
	.BLKW		;ONE-SHOT MSB OF FILE SIZE FOR .ENTER

DEV1:	.BLKW		;DEFAULT DEVICE (KEEP IN ORDER ...)
CSIWRK:	.BLKW	5	;CSI WORK AREA (... TO HERE)

CHNMAP:	.BLKW	20	;CHANNEL MAP (POINT TO CHANNEL BLOCKS)

CCLTAG:	.BLKB		;FLAG SET IF ENTERED WITH CCL (MUST BE AT EVEN BYTE!)
EMTMOD:	.BLKB		;MODE OF CSI CALL (GENERAL OR SPECIAL)

CSISIZ:	.BLKW		;Size of the CSI buffer				;001

CSIFLG:	.BLKB		;CSI flags (no sticky devices, etc)		;002
	.EVEN
			;Defined bits in CSIFLG				;002
NOSTK	= 200		;Requests no sticky devices on CSI command line	;002

.IIF GT	.-262,	.ERROR	; $DATE AT WRONG OFFSET

.DSECT	262
$DATE:	.BLKW		;RT-11 DATE WORD
SWTCNT:	.BLKW		;SWITCH COUNT FOR CSI CALLS
$USRLC:	.BLKW		;LOCATION OF USR (CONSTANT = SYSPTR)

FILSWT:	.BLKB		;CSI SWITCH (INPUT OR OUTPUT FILES)
EXITMD:	.BLKB		;-1 IF EXIT MEANS RETURN TO DEFAULT RTS
EDBASE:	.BLKW		;BASE VALUE FOR EXAMINE/DEPOSIT
JOBPPN:	.BLKW		;THIS JOB'S PPN

.IIF GT	.-276,	.ERROR	; SYSVER AT WRONG OFFSET

.DSECT	276
SYSVER:	.BLKB		;SYSTEM VERSION
SYSUPD:	.BLKB		;SYSTEM UPDATE LEVEL
CONFIG:	.BLKW		;CONFIGURATION WORD

CHNPPN:	.BLKW		;PPN OF RUNNING FILE FOR CHAINING

; SAVE AREA FOR CSI CALLS (KEEP IN ORDER ...)
HANSPC:	.BLKW		;OUTPUT AREA FOR SPC, HANDLERS FOR GEN
DEFEXT:	.BLKW		;POINTER TO DEFAULT EXTENSIONS
STRING:	.BLKW		;POINTER TO STRING TO PARSE
SAVPS:	.BLKW		;SAVED PS FROM EMT TRAP
SAVPC:	.BLKW		;SAVED PC FROM EMT TRAP
SAVRGS:	.BLKW	5	;SAVED R5-R1 FROM USER
REG0:	.BLKW		;SAVED R0 FROM USER
SCRACH:			;USEFUL FOR SCRATCH IN THE CSI
RETCSI:	.BLKW		;RETURN ADDRESS
STKSAV:			;AND THE TOP OF THE SAVE AREA IS HERE
; (... TO HERE)

SCRAT1:	.BLKW		;GENERAL SCRATCH
ARGPTR:	.BLKW		;POINTER TO ARGUMENT LIST FOR THIS EMT
ARGWRK:	.BLKW	5	;WORK BLOCK FOR ARGS REMOVED FROM STACK
V2CALL:	.BLKW	3	;PLACE TO BUILD EMT'S IN THE CSI

.DSECT	370		;FORCE CONFG2 TO THE RIGHT ADDRESS
CONFG2:	.BLKW		;SECOND CONFIGURATION WORD
	.BLKW		;RT-11 SYSTEM GENERATION JUNK
	.BLKW		;RT-11 USR SIZE (0 IN RSTS/E)

CSITBL:	.BLKB	9.*CSIPBS ;INFO GATHERED FROM LATEST CSISPC

; TELETYPE INPUT CONTROL AREA (KEEP IN ORDER ...)
CTRLCM:	.BLKW		;SET TO -1 FOR TTY WAIT TIME (^C MODE)
TTSTUS:	.BLKW		;CURRENT TTY STATUS
TTBUFP:	.BLKW		;POINTER INTO TTY INPUT BUFFER
TTICNT:	.BLKW		;NUMBER OF CHARACTERS LEFT IN BUFFER
TTIBUF:	.BLKB	TTIBFL	;TTY BUFFER
; (... TO HERE)

CHANNL:	.BLKB	17*CHANSZ ;CHANNEL BLOCKS (1 PER RSTS CHANNEL)

; DECTAPE FILE-STRUCTURED CONTROL AREA (KEEP IN ORDER ...)
DTAOWN:	.BLKW		;POINTER TO CHANNEL OF BUFFER OWNER
DTBUFF:	.BLKB	776	;510 WORD BUFFER
DTBUFP:	.BLKW		;POINTER INTO BUFFER
; (... TO HERE)

CSIBUF:			;CSI BUFFER OVERLAYS DISK BUFFER
DSKBUF:	.BLKB	1000	;ONE BLOCK DISK BUFFER
			;NOTE: CSI BUFFER = DISK BUFFER
	.BLKB	240	;RESERVE SOME STACK
KMSTAK:	.BLKW		;TOP OF KMON STACK IS HERE

RWSIZ:			;TOTAL SIZE OF R/W AREA

.IIF	NDF	L$$IST,	.ENABL	CRF
.IIF	NDF	L$$IST,	.LIST

